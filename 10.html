<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasGx - Global Natural Gas Power Mining</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gas: {
                            bg: '#0F0F0F',      
                            card: '#202020',    
                            green: '#5DD62C',   // UI Highlight Green
                            darkGreen: '#337418',
                            text: '#F8F8F8',    
                            subtext: '#94a3b8',
                            legal: '#5DD62C', 
                            grey: '#9ca3af',  
                            illegal: '#ef4444', 
                            rank1: '#FFD700', 
                            rank2: '#C0C0C0', 
                            rank3: '#CD7F32'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'glow': '0 0 10px rgba(93, 214, 44, 0.3)',
                        'glow-strong': '0 0 20px rgba(93, 214, 44, 0.6)',
                    }
                }
            }
        }
    </script>

    <style>
        :root { color-scheme: dark; }
        body {
            background-color: #0F0F0F;
            color: #F8F8F8;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- UI COMPONENTS --- */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0F0F0F; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #5DD62C; }

        .gas-card {
            background-color: rgba(32, 32, 32, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* --- MAP & GLOBE STYLES --- */
        #map-container {
            background: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%);
            position: relative;
            overflow: hidden;
            cursor: grab;
        }
        #map-container:active { cursor: grabbing; }
        
        .country {
            transition: fill 0.3s ease, stroke 0.3s ease, opacity 0.5s ease;
            filter: drop-shadow(1px 2px 2px rgba(0,0,0,0.5));
        }
        .map-has-highlight .country { opacity: 0.1; stroke: #222; filter: none; }
        .map-has-highlight .country.highlighted {
            opacity: 1 !important; 
            stroke: #fff !important;
            stroke-width: 1.5px !important;
            filter: drop-shadow(0 0 20px rgba(93, 214, 44, 0.5));
            z-index: 10;
        }
        
        .globe-glow { fill: url(#globeGradient); pointer-events: none; }

        /* --- NEW ICON STYLES (Requirement 2) --- */
        .beam-line {
            fill: none;
            stroke-width: 1.5px;
            stroke-opacity: 0.6;
            stroke-dasharray: 4,2; 
            filter: drop-shadow(0 0 2px #5DD62C);
            animation: beamFlow 1s linear infinite;
        }
        @keyframes beamFlow { from { stroke-dashoffset: 6; } to { stroke-dashoffset: 0; } }

        /* Country Label (Requirement 1: Green) */
        .country-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 700;
            fill: #5DD62C; /* Green Color */
            text-shadow: 0 0 3px rgba(0,0,0,0.8), 0 0 8px rgba(93, 214, 44, 0.4);
            opacity: 1;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        /* Double Ring Animation */
        .icon-outer-ring {
            transform-origin: 16px 16px;
            animation: spinReverse 8s linear infinite;
        }
        .icon-inner-ring {
            transform-origin: 16px 16px;
        }
        .icon-lightning {
            filter: drop-shadow(0 0 4px #5DD62C);
            animation: pulseFlash 3s infinite;
        }
        
        @keyframes spinReverse { from {transform: rotate(360deg);} to {transform: rotate(0deg);} }
        @keyframes pulseFlash { 
            0%, 100% { opacity: 0.8; filter: drop-shadow(0 0 2px #5DD62C); } 
            50% { opacity: 1; filter: drop-shadow(0 0 8px #fff); } 
        }

        /* --- HUD --- */
        .map-info-box {
            position: absolute;
            pointer-events: none;
            background: rgba(10, 15, 20, 0.85); 
            border: 1px solid rgba(93, 214, 44, 0.3);
            border-left: 3px solid #5DD62C;
            backdrop-filter: blur(8px);
            padding: 16px;
            border-radius: 4px;
            color: #fff;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            z-index: 150;
            opacity: 0;
            transition: opacity 0.3s;
            width: 260px;
        }
        .map-info-box.active { opacity: 1; pointer-events: auto; }

        /* Sidebar & Layout */
        .list-item-hover { transition: all 0.2s; border-right: 2px solid transparent; }
        .list-item-hover:hover { background: rgba(255, 255, 255, 0.05); }
        .list-item-active {
            background: linear-gradient(90deg, rgba(93, 214, 44, 0.15) 0%, transparent 100%);
            border-left-color: #5DD62C !important;
        }
        
        /* Modal */
        #detail-modal { z-index: 200; transition: opacity 0.3s ease; }
        #detail-modal.hidden { pointer-events: none; opacity: 0; }

        /* Utilities */
        .rank-text { font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body class="flex flex-col min-h-screen relative overflow-hidden bg-black text-white">

    <header class="fixed top-0 w-full z-50 gas-card h-14 lg:h-16 transition-all duration-300">
        <div class="max-w-[1920px] mx-auto px-4 h-full flex justify-between items-center">
            
            <div class="flex items-center gap-3">
                <a href="#" class="flex items-center gap-2 group" onclick="location.reload()">
                    <div class="w-8 h-8 rounded bg-gas-green flex items-center justify-center text-black font-bold text-lg"><i class="fa-solid fa-bolt"></i></div>
                    <h1 class="text-xl lg:text-2xl font-bold tracking-wider text-white">GasGx</h1>
                </a>
                <div class="hidden md:flex flex-col justify-center border-l border-white/20 pl-3 h-8">
                    <span data-i18n="tagline" class="text-gas-green text-[10px] font-bold uppercase tracking-widest">Natural Gas Power Mining</span>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex items-center bg-[#111] border border-white/10 rounded-lg p-1">
                    <button onclick="window.app.setLanguage('zh')" id="lang-zh" class="lang-btn px-2 py-1 rounded text-[10px] font-bold transition-all text-gray-400 hover:text-white">CN</button>
                    <button onclick="window.app.setLanguage('en')" id="lang-en" class="lang-btn px-2 py-1 rounded text-[10px] font-bold transition-all text-black bg-gas-green shadow-glow">EN</button>
                    <button onclick="window.app.setLanguage('ru')" id="lang-ru" class="lang-btn px-2 py-1 rounded text-[10px] font-bold transition-all text-gray-400 hover:text-white">RU</button>
                </div>
                
                <button onclick="window.app.captureAndShare()" class="hidden md:flex items-center gap-2 text-[10px] font-bold uppercase bg-white/5 hover:bg-white/10 border border-white/10 rounded px-3 py-1.5 transition-colors">
                    <i class="fa-solid fa-camera"></i> <span data-i18n="share">Share</span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow pt-14 lg:pt-16 w-full relative h-screen flex flex-col overflow-hidden">
        <div class="relative w-full flex-grow flex flex-col md:flex-row bg-[#000] overflow-hidden">
            
            <div class="w-full md:w-[260px] lg:w-[300px] h-[35%] md:h-full bg-[#0a0a0a] border-r border-white/10 flex flex-col relative z-20 shrink-0 shadow-2xl">
                <div class="p-4 border-b border-white/5 bg-[#121212]">
                    <h2 class="text-gas-green font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-trophy"></i>
                        <span data-i18n="top_producers">Global Ranking</span>
                    </h2>
                </div>
                
                <div id="country-list" class="flex-1 p-2 space-y-1 overflow-y-auto custom-scrollbar bg-[#050505]">
                    </div>
                
                <div class="p-3 border-t border-white/5 bg-[#080808] text-[10px] text-gray-500 grid grid-cols-2 gap-2">
                    <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-sm bg-gas-legal shadow-[0_0_5px_#5DD62C]"></div> <span data-i18n="status_legal">Legal</span></div>
                    <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-sm bg-gas-grey"></div> <span data-i18n="status_restricted">Restricted</span></div>
                    <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-sm bg-gas-illegal"></div> <span data-i18n="status_banned">Banned</span></div>
                </div>
            </div>

            <div class="flex-1 h-[65%] md:h-full relative bg-[#000] overflow-hidden group">
                <div id="map-container" class="w-full h-full">
                    <svg id="hud-layer" class="absolute w-full h-full pointer-events-none z-50"></svg>
                    
                    <svg style="position: absolute; width: 0; height: 0;">
                        <defs>
                            <radialGradient id="globeGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                <stop offset="85%" stop-color="#080808" stop-opacity="1"/>
                                <stop offset="100%" stop-color="#1a1a1a" stop-opacity="1"/>
                            </radialGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                    </svg>

                    <div id="map-info-box" class="map-info-box"></div>

                    <div id="map-loading" class="absolute inset-0 flex items-center justify-center bg-black z-[60]">
                        <div class="flex flex-col items-center gap-4">
                            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-gas-green shadow-glow"></i>
                            <span class="text-xs text-gas-green uppercase tracking-widest animate-pulse">Initializing Data...</span>
                        </div>
                    </div>
                </div>
                
                <div class="absolute top-4 right-4 z-10">
                    <div class="bg-black/60 backdrop-blur border border-white/10 rounded-lg p-3 text-right">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider" data-i18n="scope">Analysis Scope</div>
                        <div class="text-xl font-bold text-white font-mono">25+ <span class="text-[10px] text-gas-green" data-i18n="countries">Countries</span></div>
                    </div>
                </div>
                
                <div class="absolute bottom-4 left-4 text-[10px] text-gray-500 pointer-events-none z-10 flex items-center gap-2">
                    <i class="fa-solid fa-hand-pointer text-gas-green"></i> <span data-i18n="drag_rotate">Drag to Rotate</span>
                </div>
            </div>
        </div>
    </main>

    <div id="detail-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4 lg:p-8">
        <div class="bg-[#151515] border border-gas-green/30 w-full max-w-5xl h-[85vh] rounded-xl shadow-2xl flex flex-col overflow-hidden relative">
            
            <div class="bg-[#1a1a1a] border-b border-white/5 p-6 flex justify-between items-start shrink-0">
                <div>
                    <h2 id="modal-title" class="text-3xl font-bold text-white mb-2">COUNTRY</h2>
                    <div class="flex gap-4 text-xs uppercase tracking-wider font-bold">
                        <div class="bg-white/5 px-2 py-1 rounded text-gray-400"><span data-i18n="rank">Rank</span> <span id="modal-rank" class="text-gas-green ml-1">#1</span></div>
                        <div class="bg-white/5 px-2 py-1 rounded text-gray-400"><span data-i18n="score">Score</span> <span id="modal-score" class="text-white ml-1">--</span></div>
                    </div>
                </div>
                <button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="text-gray-500 hover:text-white transition-colors">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 lg:p-8 custom-scrollbar">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-[#202020] p-4 rounded border border-white/5">
                                <div class="text-[10px] text-gray-500 uppercase mb-1" data-i18n="gas_production">Gas Production</div>
                                <div id="modal-vol" class="text-lg font-bold text-white font-mono">-- Bcm</div>
                            </div>
                            <div class="bg-[#202020] p-4 rounded border border-white/5">
                                <div class="text-[10px] text-gray-500 uppercase mb-1" data-i18n="policy_status">Policy</div>
                                <div id="modal-policy" class="text-sm font-bold text-white">--</div>
                            </div>
                        </div>

                        <div class="bg-[#1a1a1a] p-5 rounded border border-white/5">
                            <h3 class="text-xs font-bold text-white uppercase tracking-wider mb-4 border-b border-white/5 pb-2" data-i18n="analysis_10">10-Dimension Analysis</h3>
                            <div id="modal-dims-container" class="space-y-2"></div>
                        </div>
                    </div>

                    <div class="space-y-5">
                        <div class="bg-[#132010] p-5 rounded border border-gas-green/20">
                            <h3 class="text-gas-green font-bold text-xs uppercase mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-check-circle"></i> <span data-i18n="pros">Advantages</span>
                            </h3>
                            <p id="modal-pros" class="text-sm text-gray-300 leading-relaxed">--</p>
                        </div>

                        <div class="bg-[#201010] p-5 rounded border border-red-900/30">
                            <h3 class="text-red-400 font-bold text-xs uppercase mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-triangle-exclamation"></i> <span data-i18n="cons">Risks & Challenges</span>
                            </h3>
                            <p id="modal-cons" class="text-sm text-gray-300 leading-relaxed">--</p>
                        </div>

                        <div class="bg-[#222] p-5 rounded border-l-2 border-yellow-500/50">
                            <h3 class="text-yellow-500 font-bold text-xs uppercase mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-lightbulb"></i> <span data-i18n="advice">Investment Advice</span>
                            </h3>
                            <p id="modal-advice" class="text-sm text-gray-400 leading-relaxed italic">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. MULTI-LANGUAGE DATA STRUCTURE ---
        // Refactored to support deep linking of translations
        const DIMENSION_KEYS = ["res", "cost", "policy", "grid", "stable", "climate", "transp", "entry", "opex", "safe"];
        
        const TRANSLATIONS = {
            zh: {
                tagline: "天然气发电挖矿助手",
                top_producers: "综合评分排名",
                status_legal: "合法/高分",
                status_restricted: "受限/灰色",
                status_banned: "禁止/高危",
                scope: "分析范围",
                countries: "个国家地区",
                drag_rotate: "拖动旋转地球",
                rank: "排名",
                score: "评分",
                gas_production: "天然气产量",
                policy_status: "政策状态",
                analysis_10: "十维度分析",
                pros: "核心优势",
                cons: "风险与挑战",
                advice: "投资建议",
                view_report: "查看完整报告",
                share: "分享快照",
                dims: ["资源丰富度", "成本竞争力", "挖矿政策", "电力基建", "政策稳定性", "气候适应性", "监管透明度", "市场准入", "运营成本", "投资安全"]
            },
            en: {
                tagline: "Natural Gas Power Mining",
                top_producers: "Global Ranking",
                status_legal: "Legal/High",
                status_restricted: "Restricted",
                status_banned: "Banned",
                scope: "Analysis Scope",
                countries: "Countries",
                drag_rotate: "Drag to Rotate",
                rank: "Rank",
                score: "Score",
                gas_production: "Gas Production",
                policy_status: "Policy Status",
                analysis_10: "10-Dimension Analysis",
                pros: "Advantages",
                cons: "Risks & Challenges",
                advice: "Investment Advice",
                view_report: "Full Report",
                share: "Snapshot",
                dims: ["Resource", "Cost Comp.", "Policy", "Grid Infra", "Stability", "Climate", "Transparency", "Market Entry", "OpEx", "Safety"]
            },
            ru: {
                tagline: "Майнинг на природном газе",
                top_producers: "Мировой рейтинг",
                status_legal: "Легально",
                status_restricted: "Ограничено",
                status_banned: "Запрещено",
                scope: "Объем анализа",
                countries: "стран",
                drag_rotate: "Вращать глобус",
                rank: "Рейтинг",
                score: "Баллы",
                gas_production: "Добыча газа",
                policy_status: "Статус",
                analysis_10: "Анализ 10 измерений",
                pros: "Преимущества",
                cons: "Риски",
                advice: "Совет инвестору",
                view_report: "Полный отчет",
                share: "Поделиться",
                dims: ["Ресурсы", "Стоимость", "Политика", "Электросеть", "Стабильность", "Климат", "Прозрачность", "Вход", "OpEx", "Безопасность"]
            }
        };

        const GAS_DATA = [
            { 
                id: "usa", status: "legal", score: 42, vol: 967.3, dims: [5,4,4,5,4,4,4,4,4,4],
                name: { zh: "美国", en: "United States", ru: "США" },
                mining_status: { zh: "合法/受监管", en: "Legal / Regulated", ru: "Легально / Регулируется" },
                pros: {
                    zh: "天然气资源极其丰富，成本极具竞争力。监管环境稳定，适合长期大规模投资。",
                    en: "Extremely rich natural gas resources with competitive costs. Stable regulatory environment suitable for large-scale investment.",
                    ru: "Чрезвычайно богатые ресурсы природного газа с конкурентоспособными ценами. Стабильная среда."
                },
                cons: {
                    zh: "部分州环保法规较严，合规成本较高。",
                    en: "Strict environmental regulations in some states may increase compliance costs.",
                    ru: "Строгие экологические нормы в некоторых штатах."
                },
                advice: {
                    zh: "强烈推荐：适合寻求长期稳定回报的大资金。",
                    en: "Highly Recommended: Ideal for large capital seeking long-term stability.",
                    ru: "Настоятельно рекомендуется для крупного капитала."
                }
            },
            { 
                id: "canada", status: "legal", score: 39, vol: 178.7, dims: [3,3,4,5,4,4,4,4,4,4],
                name: { zh: "加拿大", en: "Canada", ru: "Канада" },
                mining_status: { zh: "合法/受监管", en: "Legal / Regulated", ru: "Легально / Регулируется" },
                pros: { zh: "气候寒冷利于散热，能源供应稳定。", en: "Cold climate reduces cooling costs; stable energy supply.", ru: "Холодный климат снижает затраты на охлаждение." },
                cons: { zh: "部分地区碳税较高。", en: "High carbon tax in some regions.", ru: "Высокий налог на выбросы углерода." },
                advice: { zh: "推荐：优先考虑阿尔伯塔省。", en: "Recommended: Focus on Alberta.", ru: "Рекомендуется: Альберта." }
            },
            { 
                id: "russia", status: "grey", score: 32.5, vol: 701.0, dims: [5,5,2,4,2,2,2,3,4.5,3],
                name: { zh: "俄罗斯", en: "Russia", ru: "Россия" },
                mining_status: { zh: "受限/管控", en: "Restricted", ru: "Ограничено" },
                pros: { zh: "能源极其廉价且丰富。", en: "Extremely cheap and abundant energy.", ru: "Чрезвычайно дешевая и обильная энергия." },
                cons: { zh: "地缘政治风险高，资金流转困难。", en: "High geopolitical risk; payment friction.", ru: "Высокие геополитические риски." },
                advice: { zh: "高风险高回报：仅适合有强力本地资源的资方。", en: "High Risk: Only for those with strong local ties.", ru: "Высокий риск: только для местных игроков." }
            },
            { 
                id: "china", status: "illegal", score: 18, vol: 179.3, dims: [3,2,1,5,3,3,2,2,2,3],
                name: { zh: "中国", en: "China", ru: "Китай" },
                mining_status: { zh: "禁止", en: "Banned", ru: "Запрещено" },
                pros: { zh: "基建完善。", en: "Excellent infrastructure.", ru: "Отличная инфраструктура." },
                cons: { zh: "政策全面禁止挖矿。", en: "Mining is completely banned.", ru: "Майнинг полностью запрещен." },
                advice: { zh: "绝对不推荐。", en: "Not Recommended.", ru: "Не рекомендуется." }
            },
            { id: "aus", status: "legal", score: 37, vol: 142.1, dims: [3,2,4,5,4,4,4,4,3,4], name: { zh: "澳大利亚", en: "Australia", ru: "Австралия" }, mining_status: { zh: "合法", en: "Legal", ru: "Легально" }, pros: { zh: "法律完善", en: "Strong Legal System", ru: "Сильная правовая система" }, cons: { zh: "人工成本高", en: "High Labor Cost", ru: "Высокая стоимость труда" }, advice: { zh: "推荐", en: "Recommended", ru: "Рекомендуется" } },
            { id: "norway", status: "legal", score: 34.5, vol: 112.0, dims: [3,1,4,5,3.5,4,4,4,2,4], name: { zh: "挪威", en: "Norway", ru: "Норвегия" }, mining_status: { zh: "合法", en: "Legal", ru: "Легально" }, pros: { zh: "清洁能源", en: "Clean Energy", ru: "Чистая энергия" }, cons: { zh: "税收重", en: "High Taxes", ru: "Высокие налоги" }, advice: { zh: "稳健选择", en: "Stable Choice", ru: "Стабильный выбор" } },
            { id: "uae", status: "legal", score: 29.5, vol: 62.9, dims: [2,2,4,5,3,1,3,3,3.5,3], name: { zh: "阿联酋", en: "UAE", ru: "ОАЭ" }, mining_status: { zh: "合法/自贸区", en: "Legal (Freezone)", ru: "Легально" }, pros: { zh: "资本充裕", en: "Capital Rich", ru: "Богатый капитал" }, cons: { zh: "高温需液冷", en: "High Heat", ru: "Высокая жара" }, advice: { zh: "适合液冷项目", en: "For Liquid Cooling", ru: "Для жидкостного охлаждения" } },
            { id: "kaz", status: "grey", score: 30, vol: 32.0, dims: [3,4,3,3,2,3,2,3,4,2], name: { zh: "哈萨克斯坦", en: "Kazakhstan", ru: "Казахстан" }, mining_status: { zh: "受限", en: "Restricted", ru: "Ограничено" }, pros: { zh: "电费低", en: "Low Power Cost", ru: "Дешевая энергия" }, cons: { zh: "电网不稳定", en: "Unstable Grid", ru: "Нестабильная сеть" }, advice: { zh: "谨慎", en: "Caution", ru: "Осторожно" } }
        ];

        window.app = {
            currentLang: 'en',
            rotationTimer: null,
            projection: null,
            projectionAir: null, // For floating icons
            path: null,
            svg: null,
            width: 0,
            height: 0,
            countries: [],
            activeCountry: null,

            init() {
                this.updateStaticText();
                this.initGlobe();
                this.renderList();
            },

            // --- 2. LANGUAGE SWITCHER LOGIC ---
            setLanguage(lang) {
                this.currentLang = lang;
                
                // Update Buttons UI
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    const isActive = btn.id === `lang-${lang}`;
                    btn.className = isActive 
                        ? "lang-btn px-2 py-1 rounded text-[10px] font-bold transition-all text-black bg-gas-green shadow-glow"
                        : "lang-btn px-2 py-1 rounded text-[10px] font-bold transition-all text-gray-400 hover:text-white";
                });

                // Update All Content
                this.updateStaticText();
                this.renderList();
                this.updateGlobeLabels(); // Refresh map labels
                if (this.activeCountry) this.updateInfoBox(); // Refresh HUD if active
            },

            t(key) { return TRANSLATIONS[this.currentLang][key] || key; },

            updateStaticText() {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    el.innerText = this.t(key);
                });
            },

            // --- 3. D3 GLOBE IMPLEMENTATION ---
            async initGlobe() {
                const container = document.getElementById('map-container');
                this.width = container.clientWidth;
                this.height = container.clientHeight;

                this.svg = d3.select("#map-container").append("svg")
                    .attr("width", this.width).attr("height", this.height)
                    .style("position", "absolute").style("z-index", 1);

                // Earth Surface
                this.projection = d3.geoOrthographic()
                    .scale(this.height / 2.3)
                    .translate([this.width / 2, this.height / 2])
                    .clipAngle(90);

                // Atmosphere/Icon Layer (Slightly larger radius for floating effect)
                this.projectionAir = d3.geoOrthographic()
                    .scale(this.height / 2.3 * 1.3) 
                    .translate([this.width / 2, this.height / 2])
                    .clipAngle(90);

                this.path = d3.geoPath().projection(this.projection);

                try {
                    const world = await d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
                    this.countries = topojson.feature(world, world.objects.countries).features;
                    
                    document.getElementById('map-loading').style.display = 'none';

                    // 1. Atmosphere Glow
                    this.svg.append("path").datum({type: "Sphere"})
                        .attr("class", "globe-glow").attr("d", this.path);

                    // 2. Countries
                    const g = this.svg.append("g");
                    g.selectAll("path").data(this.countries).enter().append("path")
                        .attr("d", this.path)
                        .attr("class", "country")
                        .attr("id", d => `c-${d.properties.name.replace(/\s+/g, '-')}`)
                        .attr("fill", d => {
                            const data = GAS_DATA.find(x => x.name.en === d.properties.name);
                            if(data) return data.status === 'legal' ? '#1a2e15' : (data.status === 'illegal' ? '#2a1010' : '#1e1e1e');
                            return "#111";
                        })
                        .attr("stroke", "#222").attr("stroke-width", 0.5)
                        .on("click", (e, d) => this.highlight(d.properties.name));

                    // 3. Floating Icons (Requirement 2: Double Ring + Lightning)
                    this.renderIcons();

                    // 4. Drag Behavior
                    const drag = d3.drag()
                        .on("start", () => { if(this.rotationTimer) this.rotationTimer.stop(); })
                        .on("drag", (e) => {
                            const r = this.projection.rotate();
                            const k = 75 / this.projection.scale();
                            const next = [r[0] + e.dx * k, r[1] - e.dy * k];
                            this.projection.rotate(next);
                            this.projectionAir.rotate(next);
                            this.redraw();
                        });
                    this.svg.call(drag);

                    // 5. Auto Rotation
                    this.rotationTimer = d3.timer((elapsed) => {
                        const r = this.projection.rotate();
                        const next = [r[0] + 0.05, r[1]]; // Slow spin
                        this.projection.rotate(next);
                        this.projectionAir.rotate(next);
                        this.redraw();
                    });

                } catch (err) { console.error(err); }
            },

            renderIcons() {
                const group = this.svg.append("g").attr("class", "icons-layer");
                
                GAS_DATA.forEach(item => {
                    const geo = this.countries.find(c => c.properties.name === item.name.en);
                    if(!geo) return;

                    const centroid = d3.geoCentroid(geo);
                    const iconG = group.append("g")
                        .datum({ coord: centroid, data: item })
                        .attr("class", "floating-icon");

                    // Beam Line
                    iconG.append("path").attr("class", "beam-line")
                        .attr("stroke", item.status === 'legal' ? '#5DD62C' : '#999');

                    // --- NEW ICON DESIGN START ---
                    const widget = iconG.append("g").attr("transform", "translate(-16, -32)");
                    
                    // 1. Background disc
                    widget.append("circle")
                        .attr("cx", 16).attr("cy", 16).attr("r", 14)
                        .attr("fill", "#111").attr("stroke", "none");

                    // 2. Inner Ring (Static)
                    widget.append("circle")
                        .attr("class", "icon-inner-ring")
                        .attr("cx", 16).attr("cy", 16).attr("r", 8)
                        .attr("fill", "none")
                        .attr("stroke", item.status === 'legal' ? '#5DD62C' : '#666')
                        .attr("stroke-width", 1.5)
                        .attr("opacity", 0.7);

                    // 3. Outer Ring (Spinning + Dashed)
                    widget.append("circle")
                        .attr("class", "icon-outer-ring")
                        .attr("cx", 16).attr("cy", 16).attr("r", 14)
                        .attr("fill", "none")
                        .attr("stroke", item.status === 'legal' ? '#5DD62C' : '#888')
                        .attr("stroke-width", 1)
                        .attr("stroke-dasharray", "4, 4")
                        .attr("opacity", 0.9);

                    // 4. Center Lightning Bolt
                    widget.append("path")
                        .attr("class", "icon-lightning")
                        .attr("d", "M16 5 L19 14 H16 L18 24 L11 14 H14 L12 5 Z") // Custom Bolt
                        .attr("fill", "#fff")
                        .attr("transform", "scale(0.8) translate(3,3)"); // Adjust center
                    // --- NEW ICON DESIGN END ---

                    // Country Label (Requirement 1: Green)
                    iconG.append("text")
                        .attr("class", "country-label")
                        .attr("text-anchor", "middle")
                        .attr("dy", "12")
                        .text(item.name[this.currentLang]); // Dynamic Lang
                });
            },

            updateGlobeLabels() {
                // Update text content when language changes
                this.svg.selectAll(".country-label").text(d => d.data.name[this.currentLang]);
            },

            redraw() {
                this.svg.selectAll("path.country").attr("d", this.path);
                
                const center = this.projection.invert([this.width/2, this.height/2]);

                this.svg.selectAll(".floating-icon").each(function(d) {
                    const dist = d3.geoDistance(d.coord, center);
                    // Hide if on backside of globe (> 1.57 radians)
                    if (dist > 1.57) {
                        d3.select(this).style("display", "none");
                    } else {
                        d3.select(this).style("display", "block");
                        const surface = window.app.projection(d.coord);
                        const air = window.app.projectionAir(d.coord);
                        
                        d3.select(this).attr("transform", `translate(${air[0]}, ${air[1]})`);
                        // Draw line from air to surface
                        const relX = surface[0] - air[0];
                        const relY = surface[1] - air[1];
                        d3.select(this).select(".beam-line").attr("d", `M${relX},${relY} L0,0`);
                    }
                });
                
                if (this.activeCountry) this.updateInfoBox();
            },

            // --- 4. INTERACTION ---
            highlight(engName) {
                const data = GAS_DATA.find(d => d.name.en === engName);
                if (!data) return;
                
                this.activeCountry = data;
                
                // Sidebar Highlight
                document.querySelectorAll('.list-item-hover').forEach(el => {
                    el.classList.remove('list-item-active');
                    el.classList.add('opacity-50');
                });
                const activeItem = document.getElementById(`li-${data.id}`);
                if(activeItem) {
                    activeItem.classList.add('list-item-active');
                    activeItem.classList.remove('opacity-50');
                    activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Map Rotate
                const geo = this.countries.find(c => c.properties.name === engName);
                const p = d3.geoCentroid(geo);
                if(this.rotationTimer) this.rotationTimer.stop();
                
                d3.transition().duration(1200).tween("rotate", () => {
                    const r = d3.interpolate(this.projection.rotate(), [-p[0], -p[1]]);
                    return (t) => {
                        this.projection.rotate(r(t));
                        this.projectionAir.rotate(r(t));
                        this.redraw();
                    };
                });

                // Style
                d3.selectAll('.country').classed('highlighted', false);
                d3.select(`#c-${engName.replace(/\s+/g, '-')}`).classed('highlighted', true);
                d3.select('#map-container').classed('map-has-highlight', true);

                this.updateInfoBox();
            },

            updateInfoBox() {
                const box = document.getElementById('map-info-box');
                const hud = document.getElementById('hud-layer');
                hud.innerHTML = '';

                const data = this.activeCountry;
                const geo = this.countries.find(c => c.properties.name === data.name.en);
                const pos = this.projectionAir(d3.geoCentroid(geo));
                
                // Safety check: is it visible?
                const center = this.projection.invert([this.width/2, this.height/2]);
                if (d3.geoDistance(d3.geoCentroid(geo), center) > 1.57) {
                    box.classList.remove('active');
                    return;
                }

                // Build Stars
                const stars = (score) => {
                    return Array(5).fill(0).map((_, i) => 
                        `<i class="fa-solid fa-star text-[8px] ${i < Math.floor(score) ? 'text-gas-green' : 'text-gray-700'}"></i>`
                    ).join('');
                };

                const dimLabels = TRANSLATIONS[this.currentLang].dims;
                
                let dimsHtml = '';
                // Only show top 3 dims in small box
                data.dims.slice(0,3).forEach((s, i) => {
                    dimsHtml += `<div class="flex justify-between text-[10px] text-gray-400"><span>${dimLabels[i]}</span><div class="flex gap-0.5">${stars(s)}</div></div>`;
                });

                box.innerHTML = `
                    <div class="flex justify-between items-center mb-2 border-b border-white/10 pb-2">
                        <span class="font-bold text-gas-green text-sm">${data.name[this.currentLang]}</span>
                        <span class="font-mono text-white text-xs">Score: ${data.score}</span>
                    </div>
                    <div class="mb-2 text-[10px] text-white bg-white/5 p-1.5 rounded flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full ${data.status==='legal'?'bg-gas-green':'bg-red-500'}"></div>
                        ${data.mining_status[this.currentLang]}
                    </div>
                    <div class="space-y-1 mb-3">${dimsHtml}</div>
                    <button onclick="window.app.openModal()" class="w-full bg-gas-green text-black text-[10px] font-bold py-1.5 rounded hover:bg-white transition-colors">
                        ${this.t('view_report')}
                    </button>
                `;

                // Position (Top Right offset)
                const x = pos[0] + 60;
                const y = pos[1] - 80;
                box.style.left = `${x}px`;
                box.style.top = `${y}px`;
                box.classList.add('active');

                // Connector Line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                line.setAttribute('d', `M${pos[0]},${pos[1]} L${x},${y+20}`);
                line.setAttribute('stroke', '#5DD62C');
                line.setAttribute('stroke-width', '1');
                line.setAttribute('opacity', '0.5');
                hud.appendChild(line);
            },

            // --- 5. RENDER LISTS & MODALS ---
            renderList() {
                const list = document.getElementById('country-list');
                const sorted = [...GAS_DATA].sort((a,b) => b.score - a.score);
                
                list.innerHTML = sorted.map((d, i) => {
                    let rankColor = "text-gray-500";
                    if(i===0) rankColor = "text-gas-rank1";
                    if(i===1) rankColor = "text-gas-rank2";
                    if(i===2) rankColor = "text-gas-rank3";
                    
                    return `
                    <div id="li-${d.id}" onclick="window.app.highlight('${d.name.en}')" 
                         class="list-item-hover flex items-center p-2 rounded cursor-pointer border-l-2 border-transparent group">
                        <div class="w-6 text-center text-[10px] font-bold ${rankColor}">#${i+1}</div>
                        <div class="flex-1 ml-2">
                            <div class="text-xs font-bold text-gray-300 group-hover:text-white">${d.name[this.currentLang]}</div>
                            <div class="text-[9px] text-gray-500">${d.vol} Bcm</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-mono font-bold text-gas-green">${d.score}</div>
                        </div>
                    </div>`;
                }).join('');
            },

            openModal() {
                if(!this.activeCountry) return;
                const d = this.activeCountry;
                const lang = this.currentLang;
                
                document.getElementById('modal-title').innerText = d.name[lang];
                document.getElementById('modal-score').innerText = d.score;
                document.getElementById('modal-vol').innerText = d.vol + " Bcm";
                document.getElementById('modal-policy').innerText = d.mining_status[lang];
                document.getElementById('modal-policy').style.color = d.status === 'legal' ? '#5DD62C' : '#ef4444';
                
                document.getElementById('modal-pros').innerText = d.pros[lang];
                document.getElementById('modal-cons').innerText = d.cons[lang];
                document.getElementById('modal-advice').innerText = d.advice[lang];

                const dimContainer = document.getElementById('modal-dims-container');
                const dimLabels = TRANSLATIONS[lang].dims;
                
                dimContainer.innerHTML = d.dims.map((score, i) => `
                    <div class="flex justify-between items-center text-[10px] border-b border-white/5 py-1">
                        <span class="text-gray-400">${dimLabels[i]}</span>
                        <div class="flex gap-0.5">
                            ${Array(5).fill(0).map((_, idx) => 
                                `<i class="fa-solid fa-circle text-[6px] ${idx < Math.floor(score) ? 'text-gas-green' : 'text-[#333]'}"></i>`
                            ).join('')}
                        </div>
                    </div>
                `).join('');

                document.getElementById('detail-modal').classList.remove('hidden');
            },

            captureAndShare() {
                html2canvas(document.body).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `GasGx-Report-${this.activeCountry ? this.activeCountry.id : 'Global'}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }
        };

        // Boot
        window.addEventListener('DOMContentLoaded', () => window.app.init());
        window.addEventListener('resize', () => { location.reload(); }); // Simple resize handle
    </script>
</body>
</html>